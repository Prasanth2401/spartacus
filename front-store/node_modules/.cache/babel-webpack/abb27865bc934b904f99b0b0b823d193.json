{"ast":null,"code":"import * as i0 from '@angular/core';\nimport { Injectable, isDevMode, NgModule } from '@angular/core';\nimport * as i2 from '@spartacus/core';\nimport { Config, provideDefaultConfig, provideDefaultConfigFactory } from '@spartacus/core';\nimport { HttpResponse, HTTP_INTERCEPTORS } from '@angular/common/http';\nimport { tap } from 'rxjs/operators';\n\nclass PersonalizationConfig {}\n\nPersonalizationConfig.ɵfac = function PersonalizationConfig_Factory(t) {\n  return new (t || PersonalizationConfig)();\n};\n\nPersonalizationConfig.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n  token: PersonalizationConfig,\n  factory: function PersonalizationConfig_Factory(t) {\n    let r = null;\n\n    if (t) {\n      r = new (t || PersonalizationConfig)();\n    } else {\n      r = i0.ɵɵinject(Config);\n    }\n\n    return r;\n  },\n  providedIn: 'root'\n});\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(PersonalizationConfig, [{\n    type: Injectable,\n    args: [{\n      providedIn: 'root',\n      useExisting: Config\n    }]\n  }], null, null);\n})();\n\nconst PERSONALIZATION_FEATURE = 'personalization';\nconst defaultPersonalizationConfig = {\n  personalization: {\n    enabled: false,\n    httpHeaderName: {\n      id: 'Occ-Personalization-Id',\n      timestamp: 'Occ-Personalization-Time'\n    },\n    context: {\n      slotPosition: 'PlaceholderContentSlot',\n      componentId: 'PersonalizationScriptComponent'\n    }\n  }\n};\nconst PERSONALIZATION_ID_KEY = 'personalization-id';\n\nclass OccPersonalizationIdInterceptor {\n  constructor(config, occEndpoints, winRef) {\n    var _a, _b, _c, _d, _e, _f;\n\n    this.config = config;\n    this.occEndpoints = occEndpoints;\n    this.winRef = winRef;\n    this.enabled = false;\n\n    if (this.winRef.isBrowser()) {\n      this.enabled = this.winRef.localStorage && ((_a = this.config.personalization) === null || _a === void 0 ? void 0 : _a.enabled) || false;\n\n      if (this.enabled) {\n        if (!((_b = this.config.personalization) === null || _b === void 0 ? void 0 : _b.httpHeaderName) && isDevMode()) {\n          console.warn(`There is no httpHeaderName configured in Personalization`);\n        }\n\n        this.requestHeader = (_d = (_c = this.config.personalization) === null || _c === void 0 ? void 0 : _c.httpHeaderName) === null || _d === void 0 ? void 0 : _d.id.toLowerCase();\n        this.personalizationId = (_e = this.winRef.localStorage) === null || _e === void 0 ? void 0 : _e.getItem(PERSONALIZATION_ID_KEY);\n      } else if ((_f = this.winRef.localStorage) === null || _f === void 0 ? void 0 : _f.getItem(PERSONALIZATION_ID_KEY)) {\n        this.winRef.localStorage.removeItem(PERSONALIZATION_ID_KEY);\n      }\n    }\n  }\n\n  intercept(request, next) {\n    if (!this.enabled) {\n      return next.handle(request);\n    }\n\n    if (this.requestHeader && this.personalizationId && request.url.includes(this.occEndpoints.getBaseUrl())) {\n      request = request.clone({\n        setHeaders: {\n          [this.requestHeader]: this.personalizationId\n        }\n      });\n    }\n\n    return next.handle(request).pipe(tap(event => {\n      var _a;\n\n      if (event instanceof HttpResponse) {\n        if (this.requestHeader && event.headers.keys().includes(this.requestHeader)) {\n          const receivedId = event.headers.get(this.requestHeader);\n\n          if (this.personalizationId !== receivedId) {\n            this.personalizationId = receivedId;\n\n            if (this.personalizationId) {\n              (_a = this.winRef.localStorage) === null || _a === void 0 ? void 0 : _a.setItem(PERSONALIZATION_ID_KEY, this.personalizationId);\n            }\n          }\n        }\n      }\n    }));\n  }\n\n}\n\nOccPersonalizationIdInterceptor.ɵfac = function OccPersonalizationIdInterceptor_Factory(t) {\n  return new (t || OccPersonalizationIdInterceptor)(i0.ɵɵinject(PersonalizationConfig), i0.ɵɵinject(i2.OccEndpointsService), i0.ɵɵinject(i2.WindowRef));\n};\n\nOccPersonalizationIdInterceptor.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n  token: OccPersonalizationIdInterceptor,\n  factory: OccPersonalizationIdInterceptor.ɵfac,\n  providedIn: 'root'\n});\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(OccPersonalizationIdInterceptor, [{\n    type: Injectable,\n    args: [{\n      providedIn: 'root'\n    }]\n  }], function () {\n    return [{\n      type: PersonalizationConfig\n    }, {\n      type: i2.OccEndpointsService\n    }, {\n      type: i2.WindowRef\n    }];\n  }, null);\n})();\n\nconst PERSONALIZATION_TIME_KEY = 'personalization-time';\n\nclass OccPersonalizationTimeInterceptor {\n  constructor(config, occEndpoints, winRef) {\n    var _a, _b, _c, _d, _e, _f;\n\n    this.config = config;\n    this.occEndpoints = occEndpoints;\n    this.winRef = winRef;\n    this.enabled = false;\n\n    if (this.winRef.isBrowser()) {\n      this.enabled = this.winRef.localStorage && ((_a = this.config.personalization) === null || _a === void 0 ? void 0 : _a.enabled) || false;\n\n      if (this.enabled) {\n        if (!((_b = this.config.personalization) === null || _b === void 0 ? void 0 : _b.httpHeaderName) && isDevMode()) {\n          console.warn(`There is no httpHeaderName configured in Personalization`);\n        }\n\n        this.requestHeader = (_d = (_c = this.config.personalization) === null || _c === void 0 ? void 0 : _c.httpHeaderName) === null || _d === void 0 ? void 0 : _d.timestamp.toLowerCase();\n        this.timestamp = (_e = this.winRef.localStorage) === null || _e === void 0 ? void 0 : _e.getItem(PERSONALIZATION_TIME_KEY);\n      } else if ((_f = this.winRef.localStorage) === null || _f === void 0 ? void 0 : _f.getItem(PERSONALIZATION_TIME_KEY)) {\n        this.winRef.localStorage.removeItem(PERSONALIZATION_TIME_KEY);\n      }\n    }\n  }\n\n  intercept(request, next) {\n    if (!this.enabled) {\n      return next.handle(request);\n    }\n\n    if (this.requestHeader && this.timestamp && request.url.includes(this.occEndpoints.getBaseUrl())) {\n      request = request.clone({\n        setHeaders: {\n          [this.requestHeader]: this.timestamp\n        }\n      });\n    }\n\n    return next.handle(request).pipe(tap(event => {\n      var _a;\n\n      if (event instanceof HttpResponse) {\n        if (this.requestHeader && event.headers.keys().includes(this.requestHeader)) {\n          const receivedTimestamp = event.headers.get(this.requestHeader);\n\n          if (this.timestamp !== receivedTimestamp) {\n            this.timestamp = receivedTimestamp;\n\n            if (this.timestamp) {\n              (_a = this.winRef.localStorage) === null || _a === void 0 ? void 0 : _a.setItem(PERSONALIZATION_TIME_KEY, this.timestamp);\n            }\n          }\n        }\n      }\n    }));\n  }\n\n}\n\nOccPersonalizationTimeInterceptor.ɵfac = function OccPersonalizationTimeInterceptor_Factory(t) {\n  return new (t || OccPersonalizationTimeInterceptor)(i0.ɵɵinject(PersonalizationConfig), i0.ɵɵinject(i2.OccEndpointsService), i0.ɵɵinject(i2.WindowRef));\n};\n\nOccPersonalizationTimeInterceptor.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n  token: OccPersonalizationTimeInterceptor,\n  factory: OccPersonalizationTimeInterceptor.ɵfac,\n  providedIn: 'root'\n});\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(OccPersonalizationTimeInterceptor, [{\n    type: Injectable,\n    args: [{\n      providedIn: 'root'\n    }]\n  }], function () {\n    return [{\n      type: PersonalizationConfig\n    }, {\n      type: i2.OccEndpointsService\n    }, {\n      type: i2.WindowRef\n    }];\n  }, null);\n})();\n\nconst interceptors = [{\n  provide: HTTP_INTERCEPTORS,\n  useExisting: OccPersonalizationIdInterceptor,\n  multi: true\n}, {\n  provide: HTTP_INTERCEPTORS,\n  useExisting: OccPersonalizationTimeInterceptor,\n  multi: true\n}]; // TODO: Inline this factory when we start releasing Ivy compiled libraries\n\nfunction defaultPersonalizationComponentsConfig() {\n  const config = {\n    featureModules: {\n      [PERSONALIZATION_FEATURE]: {\n        cmsComponents: ['PersonalizationScriptComponent']\n      }\n    }\n  };\n  return config;\n}\n\nclass PersonalizationRootModule {}\n\nPersonalizationRootModule.ɵfac = function PersonalizationRootModule_Factory(t) {\n  return new (t || PersonalizationRootModule)();\n};\n\nPersonalizationRootModule.ɵmod = /* @__PURE__ */i0.ɵɵdefineNgModule({\n  type: PersonalizationRootModule\n});\nPersonalizationRootModule.ɵinj = /* @__PURE__ */i0.ɵɵdefineInjector({\n  providers: [...interceptors, provideDefaultConfig(defaultPersonalizationConfig), provideDefaultConfigFactory(defaultPersonalizationComponentsConfig)]\n});\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(PersonalizationRootModule, [{\n    type: NgModule,\n    args: [{\n      providers: [...interceptors, provideDefaultConfig(defaultPersonalizationConfig), provideDefaultConfigFactory(defaultPersonalizationComponentsConfig)]\n    }]\n  }], null, null);\n})();\n/**\n * Generated bundle index. Do not edit.\n */\n\n\nexport { PERSONALIZATION_FEATURE, PersonalizationConfig, PersonalizationRootModule, defaultPersonalizationComponentsConfig }; //# sourceMappingURL=spartacus-tracking-personalization-root.js.map","map":{"version":3,"sources":["D:/spartacus/front-store/node_modules/@spartacus/tracking/fesm2015/spartacus-tracking-personalization-root.js"],"names":["i0","Injectable","isDevMode","NgModule","i2","Config","provideDefaultConfig","provideDefaultConfigFactory","HttpResponse","HTTP_INTERCEPTORS","tap","PersonalizationConfig","ɵfac","ɵprov","type","args","providedIn","useExisting","PERSONALIZATION_FEATURE","defaultPersonalizationConfig","personalization","enabled","httpHeaderName","id","timestamp","context","slotPosition","componentId","PERSONALIZATION_ID_KEY","OccPersonalizationIdInterceptor","constructor","config","occEndpoints","winRef","_a","_b","_c","_d","_e","_f","isBrowser","localStorage","console","warn","requestHeader","toLowerCase","personalizationId","getItem","removeItem","intercept","request","next","handle","url","includes","getBaseUrl","clone","setHeaders","pipe","event","headers","keys","receivedId","get","setItem","OccEndpointsService","WindowRef","PERSONALIZATION_TIME_KEY","OccPersonalizationTimeInterceptor","receivedTimestamp","interceptors","provide","multi","defaultPersonalizationComponentsConfig","featureModules","cmsComponents","PersonalizationRootModule","ɵmod","ɵinj","providers"],"mappings":"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","sourcesContent":["import * as i0 from '@angular/core';\nimport { Injectable, isDevMode, NgModule } from '@angular/core';\nimport * as i2 from '@spartacus/core';\nimport { Config, provideDefaultConfig, provideDefaultConfigFactory } from '@spartacus/core';\nimport { HttpResponse, HTTP_INTERCEPTORS } from '@angular/common/http';\nimport { tap } from 'rxjs/operators';\n\nclass PersonalizationConfig {\n}\nPersonalizationConfig.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: PersonalizationConfig, deps: [], target: i0.ɵɵFactoryTarget.Injectable });\nPersonalizationConfig.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: PersonalizationConfig, providedIn: 'root', useExisting: Config });\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: PersonalizationConfig, decorators: [{\n            type: Injectable,\n            args: [{\n                    providedIn: 'root',\n                    useExisting: Config,\n                }]\n        }] });\n\nconst PERSONALIZATION_FEATURE = 'personalization';\n\nconst defaultPersonalizationConfig = {\n    personalization: {\n        enabled: false,\n        httpHeaderName: {\n            id: 'Occ-Personalization-Id',\n            timestamp: 'Occ-Personalization-Time',\n        },\n        context: {\n            slotPosition: 'PlaceholderContentSlot',\n            componentId: 'PersonalizationScriptComponent',\n        },\n    },\n};\n\nconst PERSONALIZATION_ID_KEY = 'personalization-id';\nclass OccPersonalizationIdInterceptor {\n    constructor(config, occEndpoints, winRef) {\n        var _a, _b, _c, _d, _e, _f;\n        this.config = config;\n        this.occEndpoints = occEndpoints;\n        this.winRef = winRef;\n        this.enabled = false;\n        if (this.winRef.isBrowser()) {\n            this.enabled =\n                (this.winRef.localStorage && ((_a = this.config.personalization) === null || _a === void 0 ? void 0 : _a.enabled)) ||\n                    false;\n            if (this.enabled) {\n                if (!((_b = this.config.personalization) === null || _b === void 0 ? void 0 : _b.httpHeaderName) && isDevMode()) {\n                    console.warn(`There is no httpHeaderName configured in Personalization`);\n                }\n                this.requestHeader =\n                    (_d = (_c = this.config.personalization) === null || _c === void 0 ? void 0 : _c.httpHeaderName) === null || _d === void 0 ? void 0 : _d.id.toLowerCase();\n                this.personalizationId = (_e = this.winRef.localStorage) === null || _e === void 0 ? void 0 : _e.getItem(PERSONALIZATION_ID_KEY);\n            }\n            else if ((_f = this.winRef.localStorage) === null || _f === void 0 ? void 0 : _f.getItem(PERSONALIZATION_ID_KEY)) {\n                this.winRef.localStorage.removeItem(PERSONALIZATION_ID_KEY);\n            }\n        }\n    }\n    intercept(request, next) {\n        if (!this.enabled) {\n            return next.handle(request);\n        }\n        if (this.requestHeader &&\n            this.personalizationId &&\n            request.url.includes(this.occEndpoints.getBaseUrl())) {\n            request = request.clone({\n                setHeaders: {\n                    [this.requestHeader]: this.personalizationId,\n                },\n            });\n        }\n        return next.handle(request).pipe(tap((event) => {\n            var _a;\n            if (event instanceof HttpResponse) {\n                if (this.requestHeader &&\n                    event.headers.keys().includes(this.requestHeader)) {\n                    const receivedId = event.headers.get(this.requestHeader);\n                    if (this.personalizationId !== receivedId) {\n                        this.personalizationId = receivedId;\n                        if (this.personalizationId) {\n                            (_a = this.winRef.localStorage) === null || _a === void 0 ? void 0 : _a.setItem(PERSONALIZATION_ID_KEY, this.personalizationId);\n                        }\n                    }\n                }\n            }\n        }));\n    }\n}\nOccPersonalizationIdInterceptor.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: OccPersonalizationIdInterceptor, deps: [{ token: PersonalizationConfig }, { token: i2.OccEndpointsService }, { token: i2.WindowRef }], target: i0.ɵɵFactoryTarget.Injectable });\nOccPersonalizationIdInterceptor.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: OccPersonalizationIdInterceptor, providedIn: 'root' });\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: OccPersonalizationIdInterceptor, decorators: [{\n            type: Injectable,\n            args: [{ providedIn: 'root' }]\n        }], ctorParameters: function () { return [{ type: PersonalizationConfig }, { type: i2.OccEndpointsService }, { type: i2.WindowRef }]; } });\n\nconst PERSONALIZATION_TIME_KEY = 'personalization-time';\nclass OccPersonalizationTimeInterceptor {\n    constructor(config, occEndpoints, winRef) {\n        var _a, _b, _c, _d, _e, _f;\n        this.config = config;\n        this.occEndpoints = occEndpoints;\n        this.winRef = winRef;\n        this.enabled = false;\n        if (this.winRef.isBrowser()) {\n            this.enabled =\n                (this.winRef.localStorage && ((_a = this.config.personalization) === null || _a === void 0 ? void 0 : _a.enabled)) ||\n                    false;\n            if (this.enabled) {\n                if (!((_b = this.config.personalization) === null || _b === void 0 ? void 0 : _b.httpHeaderName) && isDevMode()) {\n                    console.warn(`There is no httpHeaderName configured in Personalization`);\n                }\n                this.requestHeader =\n                    (_d = (_c = this.config.personalization) === null || _c === void 0 ? void 0 : _c.httpHeaderName) === null || _d === void 0 ? void 0 : _d.timestamp.toLowerCase();\n                this.timestamp = (_e = this.winRef.localStorage) === null || _e === void 0 ? void 0 : _e.getItem(PERSONALIZATION_TIME_KEY);\n            }\n            else if ((_f = this.winRef.localStorage) === null || _f === void 0 ? void 0 : _f.getItem(PERSONALIZATION_TIME_KEY)) {\n                this.winRef.localStorage.removeItem(PERSONALIZATION_TIME_KEY);\n            }\n        }\n    }\n    intercept(request, next) {\n        if (!this.enabled) {\n            return next.handle(request);\n        }\n        if (this.requestHeader &&\n            this.timestamp &&\n            request.url.includes(this.occEndpoints.getBaseUrl())) {\n            request = request.clone({\n                setHeaders: {\n                    [this.requestHeader]: this.timestamp,\n                },\n            });\n        }\n        return next.handle(request).pipe(tap((event) => {\n            var _a;\n            if (event instanceof HttpResponse) {\n                if (this.requestHeader &&\n                    event.headers.keys().includes(this.requestHeader)) {\n                    const receivedTimestamp = event.headers.get(this.requestHeader);\n                    if (this.timestamp !== receivedTimestamp) {\n                        this.timestamp = receivedTimestamp;\n                        if (this.timestamp) {\n                            (_a = this.winRef.localStorage) === null || _a === void 0 ? void 0 : _a.setItem(PERSONALIZATION_TIME_KEY, this.timestamp);\n                        }\n                    }\n                }\n            }\n        }));\n    }\n}\nOccPersonalizationTimeInterceptor.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: OccPersonalizationTimeInterceptor, deps: [{ token: PersonalizationConfig }, { token: i2.OccEndpointsService }, { token: i2.WindowRef }], target: i0.ɵɵFactoryTarget.Injectable });\nOccPersonalizationTimeInterceptor.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: OccPersonalizationTimeInterceptor, providedIn: 'root' });\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: OccPersonalizationTimeInterceptor, decorators: [{\n            type: Injectable,\n            args: [{ providedIn: 'root' }]\n        }], ctorParameters: function () { return [{ type: PersonalizationConfig }, { type: i2.OccEndpointsService }, { type: i2.WindowRef }]; } });\n\nconst interceptors = [\n    {\n        provide: HTTP_INTERCEPTORS,\n        useExisting: OccPersonalizationIdInterceptor,\n        multi: true,\n    },\n    {\n        provide: HTTP_INTERCEPTORS,\n        useExisting: OccPersonalizationTimeInterceptor,\n        multi: true,\n    },\n];\n\n// TODO: Inline this factory when we start releasing Ivy compiled libraries\nfunction defaultPersonalizationComponentsConfig() {\n    const config = {\n        featureModules: {\n            [PERSONALIZATION_FEATURE]: {\n                cmsComponents: ['PersonalizationScriptComponent'],\n            },\n        },\n    };\n    return config;\n}\nclass PersonalizationRootModule {\n}\nPersonalizationRootModule.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: PersonalizationRootModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule });\nPersonalizationRootModule.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: PersonalizationRootModule });\nPersonalizationRootModule.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: PersonalizationRootModule, providers: [\n        ...interceptors,\n        provideDefaultConfig(defaultPersonalizationConfig),\n        provideDefaultConfigFactory(defaultPersonalizationComponentsConfig),\n    ] });\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: PersonalizationRootModule, decorators: [{\n            type: NgModule,\n            args: [{\n                    providers: [\n                        ...interceptors,\n                        provideDefaultConfig(defaultPersonalizationConfig),\n                        provideDefaultConfigFactory(defaultPersonalizationComponentsConfig),\n                    ],\n                }]\n        }] });\n\n/**\n * Generated bundle index. Do not edit.\n */\n\nexport { PERSONALIZATION_FEATURE, PersonalizationConfig, PersonalizationRootModule, defaultPersonalizationComponentsConfig };\n//# sourceMappingURL=spartacus-tracking-personalization-root.js.map\n"]},"metadata":{},"sourceType":"module"}