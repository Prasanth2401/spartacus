{"ast":null,"code":"import * as i0 from '@angular/core';\nimport { Injectable, NgModule } from '@angular/core';\nimport * as i1 from '@spartacus/core';\nimport { PageType, ComponentDecorator, SlotDecorator } from '@spartacus/core';\nimport { filter, take } from 'rxjs/operators';\nimport * as i2 from '@spartacus/smartedit/root';\n\nclass SmartEditService {\n  constructor(cmsService, routingService, baseSiteService, zone, winRef, rendererFactory, config, scriptLoader) {\n    this.cmsService = cmsService;\n    this.routingService = routingService;\n    this.baseSiteService = baseSiteService;\n    this.zone = zone;\n    this.winRef = winRef;\n    this.rendererFactory = rendererFactory;\n    this.config = config;\n    this.scriptLoader = scriptLoader;\n    this.isPreviewPage = false; // load webApplicationInjector.js first\n\n    this.loadScript();\n\n    if (winRef.nativeWindow) {\n      const window = winRef.nativeWindow; // rerender components and slots after editing\n\n      window.smartedit = window.smartedit || {};\n\n      window.smartedit.renderComponent = (componentId, componentType, parentId) => {\n        return this.renderComponent(componentId, componentType, parentId);\n      }; // reprocess page\n\n\n      window.smartedit.reprocessPage = this.reprocessPage;\n    }\n  }\n\n  processCmsPage() {\n    this.baseSiteService.get().pipe(filter(site => Boolean(site)), take(1)).subscribe(site => {\n      this.defaultPreviewCategoryCode = site.defaultPreviewCategoryCode;\n      this.defaultPreviewProductCode = site.defaultPreviewProductCode;\n      this.cmsService.getCurrentPage().pipe(filter(Boolean)).subscribe(cmsPage => {\n        this._currentPageId = cmsPage.pageId; // before adding contract to page, we need redirect to that page\n\n        this.goToPreviewPage(cmsPage);\n        this.addPageContract(cmsPage);\n      });\n    });\n  }\n  /**\n   * load webApplicationInjector.js\n   */\n\n\n  loadScript() {\n    var _a;\n\n    this.scriptLoader.embedScript({\n      src: 'assets/webApplicationInjector.js',\n      params: undefined,\n      attributes: {\n        id: 'text/smartedit-injector',\n        'data-smartedit-allow-origin': (_a = this.config.smartEdit) === null || _a === void 0 ? void 0 : _a.allowOrigin\n      }\n    });\n  }\n  /**\n   * add CSS classes in a body tag\n   */\n\n\n  addPageContract(cmsPage) {\n    const renderer = this.rendererFactory.createRenderer('body', null);\n    const element = this.winRef.document.body; // remove old page contract\n\n    const previousContract = [];\n    Array.from(element.classList).forEach(attr => previousContract.push(attr));\n    previousContract.forEach(attr => renderer.removeClass(element, attr)); // add new page contract\n\n    this.addSmartEditContract(element, renderer, cmsPage.properties);\n  }\n  /**\n   * go to the default preview page\n   */\n\n\n  goToPreviewPage(cmsPage) {\n    // only the first page is the smartedit preview page\n    if (!this.isPreviewPage) {\n      this.isPreviewPage = true;\n\n      if (cmsPage.type === PageType.PRODUCT_PAGE && this.defaultPreviewProductCode) {\n        this.routingService.go({\n          cxRoute: 'product',\n          params: {\n            code: this.defaultPreviewProductCode,\n            name: ''\n          }\n        });\n      } else if (cmsPage.type === PageType.CATEGORY_PAGE && this.defaultPreviewCategoryCode) {\n        this.routingService.go({\n          cxRoute: 'category',\n          params: {\n            code: this.defaultPreviewCategoryCode\n          }\n        });\n      }\n    }\n  }\n  /**\n   * re-render CMS components and slots\n   */\n\n\n  renderComponent(componentId, componentType, parentId) {\n    if (componentId) {\n      this.zone.run(() => {\n        // without parentId, it is slot\n        if (!parentId) {\n          if (this._currentPageId) {\n            this.cmsService.refreshPageById(this._currentPageId);\n          } else {\n            this.cmsService.refreshLatestPage();\n          }\n        } else if (componentType) {\n          this.cmsService.refreshComponent(componentId);\n        }\n      });\n    }\n\n    return true;\n  }\n\n  reprocessPage() {// TODO: reprocess page API\n  }\n  /**\n   * add smartedit HTML markup contract\n   */\n\n\n  addSmartEditContract(element, renderer, properties) {\n    if (properties) {\n      // check each group of properties, e.g. smartedit\n      Object.keys(properties).forEach(group => {\n        const name = 'data-' + group + '-';\n        const groupProps = properties[group]; // check each property in the group\n\n        Object.keys(groupProps).forEach(propName => {\n          const propValue = groupProps[propName];\n\n          if (propName === 'classes') {\n            const classes = propValue.split(' ');\n            classes.forEach(classItem => {\n              renderer.addClass(element, classItem);\n            });\n          } else {\n            renderer.setAttribute(element, name + propName.split(/(?=[A-Z])/).join('-').toLowerCase(), propValue);\n          }\n        });\n      });\n    }\n  }\n\n}\n\nSmartEditService.ɵfac = function SmartEditService_Factory(t) {\n  return new (t || SmartEditService)(i0.ɵɵinject(i1.CmsService), i0.ɵɵinject(i1.RoutingService), i0.ɵɵinject(i1.BaseSiteService), i0.ɵɵinject(i0.NgZone), i0.ɵɵinject(i1.WindowRef), i0.ɵɵinject(i0.RendererFactory2), i0.ɵɵinject(i2.SmartEditConfig), i0.ɵɵinject(i1.ScriptLoader));\n};\n\nSmartEditService.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n  token: SmartEditService,\n  factory: SmartEditService.ɵfac,\n  providedIn: 'root'\n});\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(SmartEditService, [{\n    type: Injectable,\n    args: [{\n      providedIn: 'root'\n    }]\n  }], function () {\n    return [{\n      type: i1.CmsService\n    }, {\n      type: i1.RoutingService\n    }, {\n      type: i1.BaseSiteService\n    }, {\n      type: i0.NgZone\n    }, {\n      type: i1.WindowRef\n    }, {\n      type: i0.RendererFactory2\n    }, {\n      type: i2.SmartEditConfig\n    }, {\n      type: i1.ScriptLoader\n    }];\n  }, null);\n})();\n\nclass SmartEditComponentDecorator extends ComponentDecorator {\n  constructor(smartEditService) {\n    super();\n    this.smartEditService = smartEditService;\n  }\n\n  decorate(element, renderer, component) {\n    if (component) {\n      this.smartEditService.addSmartEditContract(element, renderer, component.properties);\n    }\n  }\n\n}\n\nSmartEditComponentDecorator.ɵfac = function SmartEditComponentDecorator_Factory(t) {\n  return new (t || SmartEditComponentDecorator)(i0.ɵɵinject(SmartEditService));\n};\n\nSmartEditComponentDecorator.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n  token: SmartEditComponentDecorator,\n  factory: SmartEditComponentDecorator.ɵfac,\n  providedIn: 'root'\n});\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(SmartEditComponentDecorator, [{\n    type: Injectable,\n    args: [{\n      providedIn: 'root'\n    }]\n  }], function () {\n    return [{\n      type: SmartEditService\n    }];\n  }, null);\n})();\n\nclass SmartEditSlotDecorator extends SlotDecorator {\n  constructor(smartEditService) {\n    super();\n    this.smartEditService = smartEditService;\n  }\n\n  decorate(element, renderer, slot) {\n    if (slot) {\n      this.smartEditService.addSmartEditContract(element, renderer, slot.properties);\n    }\n  }\n\n}\n\nSmartEditSlotDecorator.ɵfac = function SmartEditSlotDecorator_Factory(t) {\n  return new (t || SmartEditSlotDecorator)(i0.ɵɵinject(SmartEditService));\n};\n\nSmartEditSlotDecorator.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n  token: SmartEditSlotDecorator,\n  factory: SmartEditSlotDecorator.ɵfac,\n  providedIn: 'root'\n});\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(SmartEditSlotDecorator, [{\n    type: Injectable,\n    args: [{\n      providedIn: 'root'\n    }]\n  }], function () {\n    return [{\n      type: SmartEditService\n    }];\n  }, null);\n})();\n\nconst smartEditDecorators = [{\n  provide: ComponentDecorator,\n  useExisting: SmartEditComponentDecorator,\n  multi: true\n}, {\n  provide: SlotDecorator,\n  useExisting: SmartEditSlotDecorator,\n  multi: true\n}];\n\nclass SmartEditCoreModule {\n  constructor(smartEditService) {\n    this.smartEditService = smartEditService;\n    this.smartEditService.processCmsPage();\n  }\n\n}\n\nSmartEditCoreModule.ɵfac = function SmartEditCoreModule_Factory(t) {\n  return new (t || SmartEditCoreModule)(i0.ɵɵinject(SmartEditService));\n};\n\nSmartEditCoreModule.ɵmod = /* @__PURE__ */i0.ɵɵdefineNgModule({\n  type: SmartEditCoreModule\n});\nSmartEditCoreModule.ɵinj = /* @__PURE__ */i0.ɵɵdefineInjector({\n  providers: [...smartEditDecorators]\n});\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(SmartEditCoreModule, [{\n    type: NgModule,\n    args: [{\n      providers: [...smartEditDecorators]\n    }]\n  }], function () {\n    return [{\n      type: SmartEditService\n    }];\n  }, null);\n})();\n/**\n * Generated bundle index. Do not edit.\n */\n\n\nexport { SmartEditCoreModule, SmartEditService }; //# sourceMappingURL=spartacus-smartedit-core.js.map","map":{"version":3,"sources":["D:/spartacus/front-store/node_modules/@spartacus/smartedit/fesm2015/spartacus-smartedit-core.js"],"names":["i0","Injectable","NgModule","i1","PageType","ComponentDecorator","SlotDecorator","filter","take","i2","SmartEditService","constructor","cmsService","routingService","baseSiteService","zone","winRef","rendererFactory","config","scriptLoader","isPreviewPage","loadScript","nativeWindow","window","smartedit","renderComponent","componentId","componentType","parentId","reprocessPage","processCmsPage","get","pipe","site","Boolean","subscribe","defaultPreviewCategoryCode","defaultPreviewProductCode","getCurrentPage","cmsPage","_currentPageId","pageId","goToPreviewPage","addPageContract","_a","embedScript","src","params","undefined","attributes","id","smartEdit","allowOrigin","renderer","createRenderer","element","document","body","previousContract","Array","from","classList","forEach","attr","push","removeClass","addSmartEditContract","properties","type","PRODUCT_PAGE","go","cxRoute","code","name","CATEGORY_PAGE","run","refreshPageById","refreshLatestPage","refreshComponent","Object","keys","group","groupProps","propName","propValue","classes","split","classItem","addClass","setAttribute","join","toLowerCase","ɵfac","CmsService","RoutingService","BaseSiteService","NgZone","WindowRef","RendererFactory2","SmartEditConfig","ScriptLoader","ɵprov","args","providedIn","SmartEditComponentDecorator","smartEditService","decorate","component","SmartEditSlotDecorator","slot","smartEditDecorators","provide","useExisting","multi","SmartEditCoreModule","ɵmod","ɵinj","providers"],"mappings":"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","sourcesContent":["import * as i0 from '@angular/core';\nimport { Injectable, NgModule } from '@angular/core';\nimport * as i1 from '@spartacus/core';\nimport { PageType, ComponentDecorator, SlotDecorator } from '@spartacus/core';\nimport { filter, take } from 'rxjs/operators';\nimport * as i2 from '@spartacus/smartedit/root';\n\nclass SmartEditService {\n    constructor(cmsService, routingService, baseSiteService, zone, winRef, rendererFactory, config, scriptLoader) {\n        this.cmsService = cmsService;\n        this.routingService = routingService;\n        this.baseSiteService = baseSiteService;\n        this.zone = zone;\n        this.winRef = winRef;\n        this.rendererFactory = rendererFactory;\n        this.config = config;\n        this.scriptLoader = scriptLoader;\n        this.isPreviewPage = false;\n        // load webApplicationInjector.js first\n        this.loadScript();\n        if (winRef.nativeWindow) {\n            const window = winRef.nativeWindow;\n            // rerender components and slots after editing\n            window.smartedit = window.smartedit || {};\n            window.smartedit.renderComponent = (componentId, componentType, parentId) => {\n                return this.renderComponent(componentId, componentType, parentId);\n            };\n            // reprocess page\n            window.smartedit.reprocessPage = this.reprocessPage;\n        }\n    }\n    processCmsPage() {\n        this.baseSiteService\n            .get()\n            .pipe(filter((site) => Boolean(site)), take(1))\n            .subscribe((site) => {\n            this.defaultPreviewCategoryCode = site.defaultPreviewCategoryCode;\n            this.defaultPreviewProductCode = site.defaultPreviewProductCode;\n            this.cmsService\n                .getCurrentPage()\n                .pipe(filter(Boolean))\n                .subscribe((cmsPage) => {\n                this._currentPageId = cmsPage.pageId;\n                // before adding contract to page, we need redirect to that page\n                this.goToPreviewPage(cmsPage);\n                this.addPageContract(cmsPage);\n            });\n        });\n    }\n    /**\n     * load webApplicationInjector.js\n     */\n    loadScript() {\n        var _a;\n        this.scriptLoader.embedScript({\n            src: 'assets/webApplicationInjector.js',\n            params: undefined,\n            attributes: {\n                id: 'text/smartedit-injector',\n                'data-smartedit-allow-origin': (_a = this.config.smartEdit) === null || _a === void 0 ? void 0 : _a.allowOrigin,\n            },\n        });\n    }\n    /**\n     * add CSS classes in a body tag\n     */\n    addPageContract(cmsPage) {\n        const renderer = this.rendererFactory.createRenderer('body', null);\n        const element = this.winRef.document.body;\n        // remove old page contract\n        const previousContract = [];\n        Array.from(element.classList).forEach((attr) => previousContract.push(attr));\n        previousContract.forEach((attr) => renderer.removeClass(element, attr));\n        // add new page contract\n        this.addSmartEditContract(element, renderer, cmsPage.properties);\n    }\n    /**\n     * go to the default preview page\n     */\n    goToPreviewPage(cmsPage) {\n        // only the first page is the smartedit preview page\n        if (!this.isPreviewPage) {\n            this.isPreviewPage = true;\n            if (cmsPage.type === PageType.PRODUCT_PAGE &&\n                this.defaultPreviewProductCode) {\n                this.routingService.go({\n                    cxRoute: 'product',\n                    params: { code: this.defaultPreviewProductCode, name: '' },\n                });\n            }\n            else if (cmsPage.type === PageType.CATEGORY_PAGE &&\n                this.defaultPreviewCategoryCode) {\n                this.routingService.go({\n                    cxRoute: 'category',\n                    params: { code: this.defaultPreviewCategoryCode },\n                });\n            }\n        }\n    }\n    /**\n     * re-render CMS components and slots\n     */\n    renderComponent(componentId, componentType, parentId) {\n        if (componentId) {\n            this.zone.run(() => {\n                // without parentId, it is slot\n                if (!parentId) {\n                    if (this._currentPageId) {\n                        this.cmsService.refreshPageById(this._currentPageId);\n                    }\n                    else {\n                        this.cmsService.refreshLatestPage();\n                    }\n                }\n                else if (componentType) {\n                    this.cmsService.refreshComponent(componentId);\n                }\n            });\n        }\n        return true;\n    }\n    reprocessPage() {\n        // TODO: reprocess page API\n    }\n    /**\n     * add smartedit HTML markup contract\n     */\n    addSmartEditContract(element, renderer, properties) {\n        if (properties) {\n            // check each group of properties, e.g. smartedit\n            Object.keys(properties).forEach((group) => {\n                const name = 'data-' + group + '-';\n                const groupProps = properties[group];\n                // check each property in the group\n                Object.keys(groupProps).forEach((propName) => {\n                    const propValue = groupProps[propName];\n                    if (propName === 'classes') {\n                        const classes = propValue.split(' ');\n                        classes.forEach((classItem) => {\n                            renderer.addClass(element, classItem);\n                        });\n                    }\n                    else {\n                        renderer.setAttribute(element, name +\n                            propName\n                                .split(/(?=[A-Z])/)\n                                .join('-')\n                                .toLowerCase(), propValue);\n                    }\n                });\n            });\n        }\n    }\n}\nSmartEditService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: SmartEditService, deps: [{ token: i1.CmsService }, { token: i1.RoutingService }, { token: i1.BaseSiteService }, { token: i0.NgZone }, { token: i1.WindowRef }, { token: i0.RendererFactory2 }, { token: i2.SmartEditConfig }, { token: i1.ScriptLoader }], target: i0.ɵɵFactoryTarget.Injectable });\nSmartEditService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: SmartEditService, providedIn: 'root' });\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: SmartEditService, decorators: [{\n            type: Injectable,\n            args: [{\n                    providedIn: 'root',\n                }]\n        }], ctorParameters: function () { return [{ type: i1.CmsService }, { type: i1.RoutingService }, { type: i1.BaseSiteService }, { type: i0.NgZone }, { type: i1.WindowRef }, { type: i0.RendererFactory2 }, { type: i2.SmartEditConfig }, { type: i1.ScriptLoader }]; } });\n\nclass SmartEditComponentDecorator extends ComponentDecorator {\n    constructor(smartEditService) {\n        super();\n        this.smartEditService = smartEditService;\n    }\n    decorate(element, renderer, component) {\n        if (component) {\n            this.smartEditService.addSmartEditContract(element, renderer, component.properties);\n        }\n    }\n}\nSmartEditComponentDecorator.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: SmartEditComponentDecorator, deps: [{ token: SmartEditService }], target: i0.ɵɵFactoryTarget.Injectable });\nSmartEditComponentDecorator.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: SmartEditComponentDecorator, providedIn: 'root' });\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: SmartEditComponentDecorator, decorators: [{\n            type: Injectable,\n            args: [{\n                    providedIn: 'root',\n                }]\n        }], ctorParameters: function () { return [{ type: SmartEditService }]; } });\n\nclass SmartEditSlotDecorator extends SlotDecorator {\n    constructor(smartEditService) {\n        super();\n        this.smartEditService = smartEditService;\n    }\n    decorate(element, renderer, slot) {\n        if (slot) {\n            this.smartEditService.addSmartEditContract(element, renderer, slot.properties);\n        }\n    }\n}\nSmartEditSlotDecorator.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: SmartEditSlotDecorator, deps: [{ token: SmartEditService }], target: i0.ɵɵFactoryTarget.Injectable });\nSmartEditSlotDecorator.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: SmartEditSlotDecorator, providedIn: 'root' });\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: SmartEditSlotDecorator, decorators: [{\n            type: Injectable,\n            args: [{\n                    providedIn: 'root',\n                }]\n        }], ctorParameters: function () { return [{ type: SmartEditService }]; } });\n\nconst smartEditDecorators = [\n    {\n        provide: ComponentDecorator,\n        useExisting: SmartEditComponentDecorator,\n        multi: true,\n    },\n    {\n        provide: SlotDecorator,\n        useExisting: SmartEditSlotDecorator,\n        multi: true,\n    },\n];\n\nclass SmartEditCoreModule {\n    constructor(smartEditService) {\n        this.smartEditService = smartEditService;\n        this.smartEditService.processCmsPage();\n    }\n}\nSmartEditCoreModule.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: SmartEditCoreModule, deps: [{ token: SmartEditService }], target: i0.ɵɵFactoryTarget.NgModule });\nSmartEditCoreModule.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: SmartEditCoreModule });\nSmartEditCoreModule.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: SmartEditCoreModule, providers: [...smartEditDecorators] });\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: SmartEditCoreModule, decorators: [{\n            type: NgModule,\n            args: [{\n                    providers: [...smartEditDecorators],\n                }]\n        }], ctorParameters: function () { return [{ type: SmartEditService }]; } });\n\n/**\n * Generated bundle index. Do not edit.\n */\n\nexport { SmartEditCoreModule, SmartEditService };\n//# sourceMappingURL=spartacus-smartedit-core.js.map\n"]},"metadata":{},"sourceType":"module"}